# üîê Pol√≠ticas de Seguran√ßa e RBAC

## üìã Vis√£o Geral

Este documento define as pol√≠ticas de seguran√ßa obrigat√≥rias, diretrizes de implementa√ß√£o RBAC (Role-Based Access Control) e procedimentos de seguran√ßa para a Trading API.

## üõ°Ô∏è Pol√≠ticas de Seguran√ßa Obrigat√≥rias

### 1. Autentica√ß√£o

#### Requisitos Obrigat√≥rios
- ‚úÖ **Toda rota protegida** DEVE usar o middleware `auth`
- ‚úÖ **JWT tokens** s√£o obrigat√≥rios para acesso a recursos protegidos
- ‚úÖ **Tokens expirados** devem ser rejeitados automaticamente
- ‚úÖ **Bearer token** no header Authorization √© obrigat√≥rio

#### Implementa√ß√£o
```javascript
// ‚úÖ CORRETO
router.get('/protected-route', auth, controller.method);

// ‚ùå INCORRETO - Sem autentica√ß√£o
router.get('/protected-route', controller.method);
```

#### Formato do Token
```
Authorization: Bearer <jwt_token>
```

### 2. Autoriza√ß√£o (RBAC)

#### Requisitos Obrigat√≥rios
- ‚úÖ **A√ß√µes sens√≠veis** DEVEM usar `checkPermission` middleware
- ‚úÖ **Permiss√µes granulares** para cada opera√ß√£o cr√≠tica
- ‚úÖ **Princ√≠pio do menor privil√©gio** - usu√°rios s√≥ t√™m permiss√µes necess√°rias
- ‚úÖ **Verifica√ß√£o dupla** - auth + permission para rotas cr√≠ticas

#### Implementa√ß√£o
```javascript
// ‚úÖ CORRETO - Com verifica√ß√£o de permiss√£o
router.post('/operations', 
  auth, 
  checkPermission('CREATE_OPERATION'),
  validateCreateOperation,
  handleValidation,
  controller.create
);

// ‚ùå INCORRETO - Sem verifica√ß√£o de permiss√£o para a√ß√£o sens√≠vel
router.delete('/users/:id', auth, controller.delete);
```

### 3. Valida√ß√£o de Entrada

#### Requisitos Obrigat√≥rios
- ‚úÖ **Toda rota de cria√ß√£o/atualiza√ß√£o** DEVE ter valida√ß√£o
- ‚úÖ **express-validator** para valida√ß√£o estruturada
- ‚úÖ **handleValidation** middleware para tratamento de erros
- ‚úÖ **Sanitiza√ß√£o** de dados de entrada

#### Implementa√ß√£o
```javascript
// ‚úÖ CORRETO
router.post('/users',
  validateCreateUser,
  handleValidation,
  auth,
  checkPermission('CREATE_USER'),
  controller.create
);
```

### 4. Rate Limiting

#### Requisitos Obrigat√≥rios
- ‚úÖ **Opera√ß√µes de escrita** DEVEM ter rate limiting
- ‚úÖ **Diferentes limites** para diferentes tipos de opera√ß√£o
- ‚úÖ **Prote√ß√£o contra spam** e ataques de for√ßa bruta

#### Configura√ß√µes Padr√£o
```javascript
// Cria√ß√£o (mais restritivo)
createOperationLimiter: 10 requests / 15 minutos

// Atualiza√ß√£o (moderado)
updateOperationLimiter: 20 requests / 5 minutos

// Consulta (permissivo)
queryOperationLimiter: 100 requests / 15 minutos
```

### 5. Tratamento de Erros

#### Requisitos Obrigat√≥rios
- ‚úÖ **Nunca expor** informa√ß√µes sens√≠veis em erros
- ‚úÖ **Logs detalhados** para auditoria (sem dados sens√≠veis)
- ‚úÖ **Mensagens consistentes** para o usu√°rio
- ‚úÖ **Status codes apropriados**

#### C√≥digos de Status
- `401` - N√£o autenticado
- `403` - Sem permiss√£o
- `400` - Dados inv√°lidos
- `404` - Recurso n√£o encontrado
- `409` - Conflito
- `429` - Rate limit excedido
- `500` - Erro interno

## üé≠ Sistema RBAC Detalhado

### Hierarquia de Roles

```
ADMIN (N√≠vel 5)
‚îú‚îÄ‚îÄ Todas as permiss√µes
‚îî‚îÄ‚îÄ Acesso total ao sistema

TRADER (N√≠vel 4)
‚îú‚îÄ‚îÄ Gerenciar opera√ß√µes pr√≥prias
‚îú‚îÄ‚îÄ Visualizar comunidades
‚îî‚îÄ‚îÄ Interagir com contratos

COMMUNITY (N√≠vel 3)
‚îú‚îÄ‚îÄ Gerenciar comunidade pr√≥pria
‚îú‚îÄ‚îÄ Contratar/remover traders
‚îú‚îÄ‚îÄ Gerenciar comunica√ß√µes
‚îî‚îÄ‚îÄ Visualizar opera√ß√µes contratadas

MODERATOR (N√≠vel 2)
‚îú‚îÄ‚îÄ Visualizar usu√°rios
‚îú‚îÄ‚îÄ Visualizar opera√ß√µes
‚îî‚îÄ‚îÄ Enviar alertas

USER (N√≠vel 1)
‚îî‚îÄ‚îÄ Visualizar comunidades p√∫blicas

GUEST (N√≠vel 0)
‚îî‚îÄ‚îÄ Acesso m√≠nimo (visualiza√ß√£o)
```

### Matriz de Permiss√µes

| Permiss√£o | ADMIN | TRADER | COMMUNITY | MODERATOR | USER | GUEST |
|-----------|-------|--------|-----------|-----------|------|-------|
| CREATE_OPERATION | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| VIEW_OPERATION | ‚úÖ | ‚úÖ | ‚úÖ* | ‚úÖ | ‚ùå | ‚ùå |
| UPDATE_OPERATION | ‚úÖ | ‚úÖ** | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| DELETE_OPERATION | ‚úÖ | ‚úÖ** | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| CREATE_COMMUNITY | ‚úÖ | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| MANAGE_USERS | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| VIEW_SYSTEM_LOGS | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| HIRE_TRADER | ‚úÖ | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| SEND_ALERT | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚ùå |
| VIEW_COMMUNITY | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |

*Apenas opera√ß√µes de traders contratados  
**Apenas opera√ß√µes pr√≥prias

### Regras de Neg√≥cio RBAC

#### 1. Isolamento de Dados
```javascript
// Traders s√≥ veem suas pr√≥prias opera√ß√µes
if (user.roles.includes('TRADER') && !user.roles.includes('ADMIN')) {
  filter.createdBy = user._id;
}

// Comunidades s√≥ veem opera√ß√µes de traders contratados
if (user.roles.includes('COMMUNITY')) {
  const contracts = await Contract.find({ communityId: user._id });
  filter.createdBy = { $in: contracts.map(c => c.traderId) };
}
```

#### 2. Valida√ß√£o Contextual
```javascript
// Verificar se trader pertence √† comunidade antes de permitir a√ß√£o
const contract = await Contract.findOne({
  traderId: req.params.traderId,
  communityId: req.user._id,
  status: 'active'
});

if (!contract) {
  throw new ForbiddenError('Trader n√£o contratado por esta comunidade');
}
```

#### 3. Auditoria de A√ß√µes
```javascript
// Log de a√ß√µes sens√≠veis
const auditLog = {
  userId: req.user._id,
  action: 'DELETE_OPERATION',
  resourceId: operationId,
  timestamp: new Date(),
  ip: req.ip,
  userAgent: req.get('User-Agent')
};

await AuditLog.create(auditLog);
```

## üîí Implementa√ß√£o de Seguran√ßa

### 1. Middleware Chain Obrigat√≥rio

#### Para Rotas P√∫blicas
```javascript
router.get('/public-data', 
  rateLimiter,           // Rate limiting
  validateQuery,         // Valida√ß√£o de query
  handleValidation,      // Tratamento de erros
  controller.method
);
```

#### Para Rotas Protegidas
```javascript
router.post('/protected-resource',
  rateLimiter,           // Rate limiting
  validateInput,         // Valida√ß√£o de entrada
  handleValidation,      // Tratamento de erros
  auth,                  // Autentica√ß√£o
  checkPermission('PERM'), // Autoriza√ß√£o
  controller.method
);
```

#### Para Rotas Administrativas
```javascript
router.delete('/admin/resource/:id',
  adminRateLimiter,      // Rate limiting mais restritivo
  validateParams,        // Valida√ß√£o de par√¢metros
  handleValidation,      // Tratamento de erros
  auth,                  // Autentica√ß√£o
  checkPermission('ADMIN_PERM'), // Permiss√£o administrativa
  auditLogger,           // Log de auditoria
  controller.method
);
```

### 2. Valida√ß√µes Espec√≠ficas

#### Valida√ß√£o de ObjectId
```javascript
const isValidObjectId = (value) => {
  return mongoose.Types.ObjectId.isValid(value);
};

const validateObjectId = (field) => {
  return body(field)
    .custom(isValidObjectId)
    .withMessage(`${field} deve ser um ObjectId v√°lido`);
};
```

#### Valida√ß√£o de Roles
```javascript
const validateRoles = body('roles')
  .isArray()
  .withMessage('Roles deve ser um array')
  .custom(async (roles) => {
    const validRoles = await Role.find({ _id: { $in: roles } });
    if (validRoles.length !== roles.length) {
      throw new Error('Uma ou mais roles s√£o inv√°lidas');
    }
    return true;
  });
```

### 3. Prote√ß√£o de Dados Sens√≠veis

#### Hash de Senhas
```javascript
// No modelo User
userSchema.pre('save', async function (next) {
  if (!this.isModified('password')) return next();
  const salt = await bcrypt.genSalt(10);
  this.password = await bcrypt.hash(this.password, salt);
  next();
});
```

#### Exclus√£o de Campos Sens√≠veis
```javascript
// Sempre excluir campos sens√≠veis nas respostas
const user = await User.findById(id).select('-password -__v');

// Ou usar transform no schema
userSchema.set('toJSON', {
  transform: function(doc, ret) {
    delete ret.password;
    delete ret.__v;
    return ret;
  }
});
```

## üö® Procedimentos de Seguran√ßa

### 1. Detec√ß√£o de Anomalias

#### M√∫ltiplas Tentativas de Login
```javascript
const loginAttempts = await LoginAttempt.countDocuments({
  email: req.body.email,
  createdAt: { $gte: new Date(Date.now() - 15 * 60 * 1000) }
});

if (loginAttempts >= 5) {
  throw new TooManyRequestsError('Muitas tentativas de login');
}
```

#### Acesso Suspeito
```javascript
// Detectar acesso de IPs diferentes em curto per√≠odo
const recentLogins = await LoginLog.find({
  userId: user._id,
  createdAt: { $gte: new Date(Date.now() - 60 * 60 * 1000) }
});

const uniqueIPs = [...new Set(recentLogins.map(log => log.ip))];
if (uniqueIPs.length > 3) {
  // Alertar sobre poss√≠vel comprometimento
  await SecurityAlert.create({
    userId: user._id,
    type: 'SUSPICIOUS_ACCESS',
    details: { ips: uniqueIPs }
  });
}
```

### 2. Auditoria e Compliance

#### Log de A√ß√µes Cr√≠ticas
```javascript
const criticalActions = [
  'DELETE_USER',
  'CHANGE_PERMISSIONS',
  'DELETE_OPERATION',
  'MODIFY_ROLE',
  'ACCESS_ADMIN_PANEL'
];

if (criticalActions.includes(action)) {
  await AuditLog.create({
    userId: req.user._id,
    action,
    resourceId,
    details: sanitizeLogData(req.body),
    timestamp: new Date(),
    ip: req.ip,
    userAgent: req.get('User-Agent')
  });
}
```

#### Reten√ß√£o de Logs
```javascript
// Manter logs por 1 ano
const oneYearAgo = new Date();
oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

await AuditLog.deleteMany({
  createdAt: { $lt: oneYearAgo }
});
```

### 3. Resposta a Incidentes

#### Bloqueio Autom√°tico
```javascript
// Bloquear usu√°rio ap√≥s atividade suspeita
if (suspiciousActivity) {
  await User.findByIdAndUpdate(userId, {
    disabled: true,
    disabledReason: 'Atividade suspeita detectada',
    disabledAt: new Date()
  });
  
  // Invalidar todas as sess√µes
  await Session.deleteMany({ userId });
  
  // Notificar administradores
  await notifyAdmins('USER_BLOCKED', { userId, reason });
}
```

#### Rota√ß√£o de Chaves
```javascript
// Rotacionar API keys periodicamente
const rotateApiKeys = async () => {
  const newKey = crypto.randomBytes(32).toString('hex');
  
  // Atualizar em produ√ß√£o
  await updateEnvironmentVariable('WEBHOOK_API_KEY', newKey);
  
  // Notificar integra√ß√µes
  await notifyIntegrations('API_KEY_ROTATED', { newKey });
};
```

## üìã Checklist de Seguran√ßa

### Para Cada Nova Rota
- [ ] Middleware `auth` implementado (se protegida)
- [ ] Middleware `checkPermission` com permiss√£o espec√≠fica (se sens√≠vel)
- [ ] Valida√ß√£o de entrada implementada
- [ ] Rate limiting configurado
- [ ] Tratamento de erros apropriado
- [ ] Logs de auditoria (se cr√≠tica)
- [ ] Testes de seguran√ßa realizados
- [ ] Documenta√ß√£o Swagger atualizada
- [ ] Revis√£o de c√≥digo de seguran√ßa

### Para Cada Nova Permiss√£o
- [ ] Nome descritivo e √∫nico
- [ ] Descri√ß√£o clara do que permite
- [ ] Associada √†s roles apropriadas
- [ ] Testada em diferentes cen√°rios
- [ ] Documentada neste arquivo
- [ ] Implementada nos middlewares

### Para Cada Nova Role
- [ ] Nome √∫nico e descritivo
- [ ] Permiss√µes m√≠nimas necess√°rias
- [ ] Testada com usu√°rios reais
- [ ] Documentada com casos de uso
- [ ] Integrada aos scripts de seed

## üö´ Pr√°ticas Proibidas

### Nunca Fazer
1. ‚ùå **Hardcode** de credenciais no c√≥digo
2. ‚ùå **Logs** de senhas ou tokens
3. ‚ùå **Bypass** de autentica√ß√£o em produ√ß√£o
4. ‚ùå **Permiss√µes excessivas** para roles
5. ‚ùå **Dados sens√≠veis** em URLs
6. ‚ùå **Valida√ß√£o** apenas no frontend
7. ‚ùå **Confian√ßa** em dados do cliente
8. ‚ùå **Exposi√ß√£o** de stack traces
9. ‚ùå **Reutiliza√ß√£o** de tokens expirados
10. ‚ùå **Acesso direto** ao banco sem valida√ß√£o

### Sempre Fazer
1. ‚úÖ **Validar** todas as entradas
2. ‚úÖ **Autenticar** antes de autorizar
3. ‚úÖ **Logs** de a√ß√µes cr√≠ticas
4. ‚úÖ **Princ√≠pio** do menor privil√©gio
5. ‚úÖ **Sanitizar** dados de sa√≠da
6. ‚úÖ **Criptografar** dados sens√≠veis
7. ‚úÖ **Verificar** permiss√µes em cada request
8. ‚úÖ **Atualizar** depend√™ncias regularmente
9. ‚úÖ **Monitorar** atividades suspeitas
10. ‚úÖ **Testar** cen√°rios de seguran√ßa

---

## üìû Contato de Seguran√ßa

Para reportar vulnerabilidades ou d√∫vidas de seguran√ßa:
1. **N√£o** abra issues p√∫blicas
2. **Contate** a equipe de seguran√ßa diretamente
3. **Forne√ßa** detalhes t√©cnicos completos
4. **Aguarde** confirma√ß√£o antes de divulgar

**Lembre-se**: A seguran√ßa √© responsabilidade de todos os desenvolvedores!